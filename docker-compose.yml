services:
  main-nginx:
    image: nginx:latest
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/sites:/etc/nginx/sites
      - ./html:/usr/share/nginx/html
      - /dev/null:/etc/nginx/conf.d/default.conf
    ports:
      - "8085:80"
    depends_on:
      - plugin-site1
      - plugin-site2
      - plugin-widget1
      - plugin-widget2
      - plugin-widget3
      - plugin-widget4
      - plugin-widget5
      - plugin-widget11
      # - plugin-widget6
      # - plugin-widget7
      # - plugin-widget8
      # - plugin-widget9
      - plugin-widget10
    networks:
      - default
      - app-network

  plugin-site1:
    build: ./plugin/site1
    expose:
      - "80"
    container_name: plugin-site1

  plugin-site2:
    build: ./plugin/site2
    expose:
      - "80"
    container_name: plugin-site2

  plugin-widget1:
    build: ./plugin/widget1
    expose:
      - "80"
    container_name: plugin-widget1
  plugin-widget2:
    build: ./plugin/widget2
    expose:
      - "80"
    container_name: plugin-widget2
  plugin-widget3:
    build: ./plugin/widget3
    expose:
      - "80"
    container_name: plugin-widget3
  plugin-widget4:
    build: ./plugin/widget4
    expose:
      - "80"
    container_name: plugin-widget4
  plugin-widget5:
    build: ./plugin/widget5
    expose:
      - "80"
    container_name: plugin-widget5
  plugin-widget11:
    build: ./plugin/widget11
    expose:
      - "80"
    container_name: plugin-widget11
  # plugin-widget6:
  #   build: ./plugin/widget6
  #   expose:
  #     - "80"
  #   container_name: plugin-widget6
  # plugin-widget7:
  #   build: ./plugin/widget7
  #   expose:
  #     - "80"
  #   container_name: plugin-widget7
  # plugin-widget8:
  #   build: ./plugin/widget8
  #   expose:
  #     - "80"
  #   container_name: plugin-widget8
  # plugin-widget9:
  #   build: ./plugin/widget9
  #   expose:
  #     - "80"
  #   container_name: plugin-widget9
  # plugin-widget10:
  #   build: ./plugin/widget10
  #   expose:
  #     - "80"
  # Widget 10 Database
  widget10-db:
    image: postgres:15
    container_name: widget10-db
    restart: always
    ports:
      - "5437:5432"
    environment:
      POSTGRES_DB: monitoring_db
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: password123
    volumes:
      - widget10-pgdata:/var/lib/postgresql/data
    networks:
      - app-network

  # Widget 10 Backend
  widget10-backend:
    build: ./plugin/widget10/backend
    container_name: widget10-backend
    ports:
      - "8011:8011"
    depends_on:
      - widget10-db
    environment:
      - DB_HOST=widget10-db
      - DB_PORT=5432
      - DB_NAME=monitoring_db
      - DB_USER=admin
      - DB_PASSWORD=password123
      - API_KEY=ssshh
      - CORS_ORIGINS=http://localhost:3111,http://localhost:8085
    networks:
      - app-network
    volumes:
      - ./plugin/widget10/backend:/app

  # Widget 10 Frontend
  plugin-widget10:
    build: ./plugin/widget10/frontend
    container_name: plugin-widget10
    ports:
      - "3111:3111"
    volumes:
      - ./plugin/widget10/frontend:/app
      - /app/node_modules # Prevent host node_modules from shadowing container ones
    environment:
      - BROWSER=none
      - PUBLIC_URL=/widget10
      - REACT_APP_API_URL=https://ocean-plugin.spc.int/widget10-api # for production
      #- REACT_APP_API_URL=http://localhost:8085/widget10-api # for development      
      - PORT=3111
      - CHOKIDAR_USEPOLLING=true
      - WDS_SOCKET_PORT=3111
    depends_on:
      - widget10-backend
    networks:
      - app-network

networks:
  default:
    driver: bridge
  app-network:
    driver: bridge

volumes:
  widget10-pgdata:
